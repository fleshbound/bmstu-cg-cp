\chapter{Аналитическая часть}

В данном разделе формализована задача синтеза изображения предмета в неотполированном цветном зеркале в контексте моделирования статической сцены, проанализированы известные алгоритмы решения этой задачи.

\section{Формализация задачи синтеза изображения}

На рисунке \ref{img:task_diagram_a0} представлена диаграмма IDEF0 формализуемой задачи.

\includeimage{task_diagram_a0}{f}{h}{0.9\textwidth}{Диаграмма IDEF0 формализуемой задачи} 

\textit{Модель} --- отображение формы и размеров какой-либо сущности~\cite{куров}.

В данной работе используется поверхностное представление моделей, при котором они представляются аналитически (полностью или частично)~\cite{куров}.

Процесс получения модели называется \textit{моделированием}.

Сцена состоит из набора сущностей:
\begin{enumerate}
	\item \textit{наблюдатель}, характеризующийся положением точки наблюдения в пространстве, направлениями взгляда и вертикальной оси~\cite{куров};
	\item \textit{точечный источник света}, характеризующийся положением в пространстве, интенсивностью и цветом света~\cite{куров};
	\item \textit{предмет} --- модель геометрического тела, свойства (радиус, высота и так далее) которого определяются заданными пользователем параметрами;
	\item \textit{зеркало} --- модель ограниченной поверхности, обладающая степенью полировки, цветом, радиусом и описанием границ.
\end{enumerate}

Зеркало и предмет называются \textit{объектами (сцены)}.

Модели, используемые в работе, требуют соблюдения физических законов.

\section{Физическая природа зеркальных поверхностей}

\textit{Луч (световой)} --- узкий пучок света, представленный геометрической линией, вдоль которой в определенном направлении распространяется свет~\cite{тюрин2005физика},~\cite{оптика20036}. 
В геометрической оптике полагается, что луч распространяется прямолинейно до тех пор, пока не встретится отражающая поверхность или граница среды преломления \cite{порев2002компьютерная}.

Если луч падает на поверхность в точку $A$ и отражается от нее, а через эту точку к поверхности проведена нормаль $n$, то углы, заключенные между нормалью и направлениями падающего, отраженного лучей ($a$, $b$), называются углами \textit{падения}, \textit{отражения} соответственно \cite{тюрин2005физика}, \cite{оптика20036}, \cite{rodionov}.
Описанные элементы представлены на рисунке \ref{img:reflection}.

\includeimage{reflection}{f}{h}{0.9\textwidth}{Отражение луча от поверхности}

\textit{Зеркало} --- поверхность, от которой отражаются лучи.
\textit{Зеркальным отражением} называется такое отражение, для которого справедлива формула~\ref{eq:reflect}:
\begin{equation}\label{eq:reflect}
	\alpha=\beta,
\end{equation}
где $\alpha$ --- угол падения, $\beta$ --- угол отражения, лучи и нормаль находятся в одной плоскости \cite{порев2002компьютерная}, \cite{оптика20036}, \cite{rodionov}.

Отражение луча света от некоторого объекта сцены представлено на рисунке \ref{img:scene_reflection}.
Рисунок \ref{img:scene_reflection} содержит следующие обозначения: $\overrightarrow N$ --- нормаль к поверхности в точке падения луча, $\overrightarrow V$, $\overrightarrow L$, $\overrightarrow R$ --- векторы, обозначающие направления от точки объекта к наблюдателю, обратное вектору наблюдения и отраженного луча (который вычисляется по формуле \ref{eq:refl_ray}) соответственно, $\alpha = \angle (\overrightarrow{L}, \overrightarrow{N})$, $\beta = \angle (\overrightarrow{N}, \overrightarrow{R})$, $\omega = \angle (\overrightarrow{R}, \overrightarrow{V})$.

\includeimage{scene_reflection}{f}{h}{0.9\textwidth}{Отражение луча света от некоторого объекта сцены}

\begin{equation}\label{eq:refl_ray}
	\overrightarrow{R} = \overrightarrow{L} - 2 \cdot \overrightarrow{N} \cdot (\overrightarrow{N}, \overrightarrow{L})
\end{equation}

\textit{Идеальным зеркалом} называется такое зеркало, отраженный от которого свет наблюдатель с направлением взгляда -$\overrightarrow V$ сможет увидеть только в том случае, если угол $\omega$ равен нулю, а для $\alpha$ и $\beta$ выполняется формула \ref{eq:reflect} \cite{демин2011}.

Для зеркал, которые не являются идеальными, отражение описывается моделью Фонга, согласно которой интенсивность $I_s$ отраженного света представлена в виде формулы \ref{eq:intense_phong} \cite{порев2002компьютерная}, \cite{демин2011}:

\begin{equation}\label{eq:intense_phong}
	I_s=I_p K_s cos^n{\omega},
\end{equation}
где $K_s$ --- коэффициент, учитывающий свойства объекта параметром зеркальности, $n$ --- числовой коэффициент, связанный со скоростью убывания интенсивности отраженного света, $I_p$ --- интенсивность точечного источника света.

\textit{Диффузным отражением} называется такое отражение, при котором равенство из формулы \ref{eq:reflect} не выполняется и происходит равномерное по всем направлениям рассеивание отраженного света \cite{порев2002компьютерная}, \cite{демин2011}.
Его интенсивность $I_d$ можно найти по закону Ламберта, выраженному формулой \ref{eq:intense_lambert} \cite{демин2011}:

\begin{equation}\label{eq:intense_lambert}
	I_d=I_p K_d \, cos{\alpha},
\end{equation}
где $K_d$ --- коэффициент, учитывающий свойства объекта параметром диффузного отражения, $cos{\alpha} = (\overrightarrow L, \overrightarrow N)$.

Согласно модели Уиттеда интенсивность $I$ некоторой точки  с некоторыми оптическими свойствами определяется суммарной интенсивностью по формуле \ref{eq:intense_whitted} с использованием формул \ref{eq:intense_phong}, \ref{eq:intense_lambert} \cite{порев2002компьютерная}, \cite{демин2011}, \cite{боресков}:

\begin{equation}\label{eq:intense_whitted}
	I = I_a \, K_a \, C + I_t \, K_t + I_p \, K_d \, C \, cos(\overrightarrow L, \overrightarrow N) + I_p \, K_s \, cos^n{\omega} + I_r \, K_r,
\end{equation}
где $I_t$, $I_r$, $I_a$ --- интенсивности преломленного и отраженного лучей, фонового света, $K_t$, $K_a$, $K_r$ --- коэффициенты, учитывающие свойства объекта параметрами прозрачности, фоновой подсветки и отражения, $C$ --- цвет точки.

\section{Существующие алгоритмы решения задачи}

Среди известных алгоритмов визуализации поверхностей существуют такие алгоритмы, как выбрасывание лучей (raycasting), пошаговое распространение лучей (ray marching), обратная трассировка лучей.

\subsection{Описание алгоритмов}

\textit{Обратная трассировка лучей} представлена авторами \cite{порев2002компьютерная}, \cite{демин2011} этапами:
\begin{enumerate}
	\item от наблюдателя в каждую точку (пиксель) экрана испускаются первичные лучи;
	\item один из лучей достигает объекта;
	\item луч преломляется или отражается, то есть порождает вторичные лучи;
	\item обработка луча прекращается, когда он перестает пересекать объекты сцены.
\end{enumerate}

Интенсивность некоторой точки объекта в описанном алгоритме вычисляется по формуле \ref{eq:intense_whitted}.

Пример визуализации обработки луча в алгоритме обратной трассировки представлен на рисунке \ref{img:raytracing}.

\includeimage{raytracing}{f}{h}{0.9\textwidth}{Визуализация обработки луча в алгоритме обратной трассировки \cite{божко2007компьютерная}}

В соответствии с \cite{евстратов2020создание} \textit{алгоритм выбрасывания лучей (raycasting)} позволяет обрабатывать поверхностные модели и представляется в виде последовательности шагов (выполняемыми для каждого шага угла обзора):
\begin{enumerate}
	\item испустить луч из точки наблюдения;
	\item рассчитать расстояние от места испускания луча до каждого из объектов сцены;
	\item определить, для какого из них оно является наименьшим;
	\item выполнить визуализацию вертикальной <<полосы>> этого объекта.
\end{enumerate}

Пример визуализации процесса обработки модели алгоритмом выбрасывания лучей представлен на рисунке \ref{img:raycasting}.

\includeimage{raycasting}{f}{H}{0.9\textwidth}{Визуализация процесса обработки 2D карты алгоритмом выбрасывания лучей (raycasting) \cite{ellis1991ray}}

\textit{Алгоритм пошагового распространения лучей (ray marching)} описывается в \cite{bredenbals2022visualising} для каждого луча, испускаемого из точки наблюдения через пиксели экрана, следующими действиями:
\begin{enumerate}
	\item рассчитать значения функции расстояния со знаком до каждого объекта сцены относительно текущей точки начала распространения луча;
	\item выбрать наименьшее из этих значений;
	\item если выбранное расстояние меньше некоторой заданной малой величины, запустить рекурсивное распространение лучей из точки объекта в соответствии с оптическими свойствами его поверхности;
	\item если выбранное расстояние больше некоторой заданной большой величины, визуализировать фон;
	\item принять за следующую точку начала ту, которая находится на выбранном расстоянии по направлению распространения исходного луча, перейти на шаг 1.
\end{enumerate}

Пример визуализации обработки одного луча в алгоритме пошагового распространения представлен на рисунке \ref{img:raymarching}.

\includeimage{raymarching}{f}{h}{0.9\textwidth}{Визуализация обработки одного луча в алгоритме пошагового распространения \cite{bredenbals2022visualising}}

\subsection{Сравнение алгоритмов}

На основе источников, которые были использованы для приведенного выше описания, осуществлено сравнение анализируемых алгоритмов.

В таблице \ref{tab:compare} приведены результаты сравнения, критерии которого расположены по горизонтали и включают в себя:
\begin{enumerate}
	\item сложность алгоритма в зависимости от чисел пикселей $C$ и объектов $N$;
	\item рабочее пространство алгоритма (сцены --- <<С>>, экранное --- <<Э>>);
	\item форма моделей, которая может быть использована при использовании алгоритма (каркасная~---~<<К>>, поверхностная --- <<П>>, объемная --- <<О>>);
	\item возможность совмещения алгоритма и модели освещения Уиттеда;
	\item принадлежность обрабатываемых точек объекту.
%	\item наличие обработки только тех первичных лучей, которые образуют текущее изображение на экране.
\end{enumerate}

\begin{table}[hbtp]
	\begin{center}
		\begin{flushleft}
			\caption{\label{tab:compare}Сравнение существующих алгоритмов решения задачи синтеза изображения в контексте моделирования статической сцены}
		\end{flushleft}
		\begin{tabular}{|l | l | l | l | l | l |} 
			\hline 
			~					& {1} & {2} & {3} & {4} & {5} \\ \hline
			Выбрасывание лучей & \texttt{$O(C \cdot N)$} & Э & П  & Нет & Да \\ \hline
			Пошаговое распространение лучей & \texttt{$O(C \cdot N)$} & Э & О & Да & Нет \\ \hline
%			Прямая трассировка лучей & \texttt{$O(C \cdot N)$} & Э & О & Да & Да \\ \hline
			Обратная трассировка лучей & \texttt{$O(C \cdot N)$} & Э & О & Да & Да \\ \hline
		\end{tabular}
	\end{center}
\end{table}

\section*{Вывод}

В данном разделе была выполнена формализация объектов сцены и задачи синтеза изображения предмета в неотполированном цветном зеркале в контексте моделирования статической сцены, проанализированы известные алгоритмы решения этой задачи, предметная область зеркал.

В качестве основного алгоритма выбрана обратная трассировка лучей с использованием модели освещения Уиттеда.